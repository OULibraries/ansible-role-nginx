{% for upstream in item.upstreams %}
upstream {{ upstream.name }} {
{% for server in upstream.servers %}
  server             {{ server }};
}
{% endfor %}
{% endfor %}

server {
  listen              80;
  server_name         {{ item.name }};

  # ACME challenge
  location /.well-known/acme-challenge {
    alias {{ nginx_acme_challenge_dir }}/.well-known/acme-challenge;
  }

  # root
  location / {
    return 301 https://$host$request_uri;
  }
}

server {
  listen              443;
  server_name         {{ item.name }};

  ssl                 on;
{% if (item.cert_type is defined) and (item.cert_type == "acme") %}
  ssl_certificate     {{ nginx_cert_path }}/{{ item.name }}/fullchain.pem;
  ssl_certificate_key {{ nginx_cert_path }}/{{ item.name }}/privkey.pem;
{% else %}
  ssl_certificate     {{ nginx_cert_path }}/{{ item.name }}/fullchain.pem;
  ssl_certificate_key {{ nginx_key_path }}/{{ item.name }}/privkey.pem;
{% endif %}
  access_log          /var/log/nginx/{{ item.name }}.access.log;

  # Global Proxy settings for this server_name
  proxy_set_header    Host $host;
  proxy_set_header    X-Real-IP $remote_addr;
  proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header    X-Forwarded-Proto $scheme;
  proxy_cache_valid 200 301 302 401 403 404 5m;
  proxy_cache_bypass $no_cache $http_cache_control;
  proxy_cache_revalidate  on;
  proxy_cache cache;

{% if item.robots == "disallow" %}
  # robots.txt overlay
  location =/robots.txt {
    alias             /srv/robots/robots.disallow.txt;
  }
{% elif item.robots == "dspace" %}
  # robots.txt overlay
  location =/robots.txt {
    alias             /srv/robots/robots.dspace.txt;
  }
{% endif %}
{% if (item.redirect_locations is defined) %}
{% for redirect_location in item.redirect_locations %}

  # Redirect {{ redirect_location.src }} to {{ redirect_location.dest }}
  location {{ redirect_location.src }} {
    return {{ redirect_location.code }} {{ redirect_location.dest }};
  }
{% endfor %}
{% endif %}
{% for upstream in item.upstreams %}

  # {{ upstream.name }}
{% for location in upstream.locations %}

  # {{ location }}
  location {{ location }} {
    # Make sure we keep this nginx setting intact
    add_header        X-Content-Type-Options nosniff;
    proxy_pass        https://{{ upstream.name }}{{ location }};
  }
{% endfor %}
{% endfor %}
}
